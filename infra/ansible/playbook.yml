---
- name: Configure app server
  hosts: all
  become: true

  vars:
    app_dir: /opt/myrafeeq
    ngrok_authtoken: "{{ lookup('env', 'NGROK_AUTHTOKEN') }}"
    ngrok_domain: "{{ lookup('env', 'NGROK_DOMAIN') }}"

  tasks:
    - name: Install packages
      ansible.builtin.apt:
        name:
          - docker.io
          - docker-compose-v2
          - nginx
        state: present
        update_cache: true

    - name: Add ngrok GPG key
      ansible.builtin.apt_key:
        url: https://ngrok-agent.s3.amazonaws.com/ngrok.asc
        state: present

    - name: Add ngrok repository
      ansible.builtin.apt_repository:
        repo: "deb https://ngrok-agent.s3.amazonaws.com buster main"
        state: present

    - name: Install ngrok
      ansible.builtin.apt:
        name: ngrok
        state: present
        update_cache: true

    - name: Set ngrok authtoken
      ansible.builtin.command:
        cmd: ngrok config add-authtoken {{ ngrok_authtoken }}
      changed_when: true
      when: ngrok_authtoken | length > 0

    - name: Create ngrok systemd service
      ansible.builtin.copy:
        dest: /etc/systemd/system/ngrok.service
        mode: "0644"
        content: |
          [Unit]
          Description=ngrok tunnel
          After=network.target

          [Service]
          Environment=HOME=/root
          ExecStart=/usr/local/bin/ngrok http --url={{ ngrok_domain }} 80
          Restart=always
          RestartSec=10

          [Install]
          WantedBy=multi-user.target
      register: ngrok_service

    - name: Start services
      ansible.builtin.systemd:
        name: "{{ item }}"
        enabled: true
        state: started
      loop:
        - docker
        - nginx
        - ngrok

    - name: Restart ngrok if config changed
      ansible.builtin.systemd:
        name: ngrok
        state: restarted
        daemon_reload: true
      when: ngrok_service.changed

    - name: Create app directory
      ansible.builtin.file:
        path: "{{ app_dir }}/postgresql"
        state: directory
        mode: "0755"

    - name: Copy docker-compose.yml
      ansible.builtin.copy:
        src: ../deploy/docker-compose.yml
        dest: "{{ app_dir }}/docker-compose.yml"
        mode: "0644"
      register: compose_file

    - name: Copy postgresql env
      ansible.builtin.copy:
        src: ../deploy/postgresql/.env
        dest: "{{ app_dir }}/postgresql/.env"
        mode: "0600"
      register: env_file

    - name: Copy init schema
      ansible.builtin.copy:
        src: ../deploy/postgresql/init-schema.sql
        dest: "{{ app_dir }}/postgresql/init-schema.sql"
        mode: "0644"
      register: schema_file

    - name: Copy pg_hba.conf
      ansible.builtin.copy:
        src: ../deploy/postgresql/pg_hba.conf
        dest: "{{ app_dir }}/postgresql/pg_hba.conf"
        mode: "0644"
      register: pg_hba_file

    - name: Start containers
      ansible.builtin.shell:
        cmd: docker compose up -d
        chdir: "{{ app_dir }}"
      when: compose_file.changed or env_file.changed or schema_file.changed or pg_hba_file.changed
