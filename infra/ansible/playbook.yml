---
- name: Configure app server
  hosts: all
  become: true

  vars:
    app_dir: /opt/myrafeeq

  tasks:
    - name: Install packages
      ansible.builtin.apt:
        name:
          - docker.io
          - docker-compose-v2
          - nginx
        state: present
        update_cache: true

    - name: Start services
      ansible.builtin.systemd:
        name: "{{ item }}"
        enabled: true
        state: started
      loop:
        - docker
        - nginx

    - name: Create app directory
      ansible.builtin.file:
        path: "{{ app_dir }}/postgresql"
        state: directory
        mode: "0755"

    - name: Copy docker-compose.yml
      ansible.builtin.copy:
        src: ../deploy/docker-compose.yml
        dest: "{{ app_dir }}/docker-compose.yml"
        mode: "0644"
      register: compose_file

    - name: Copy postgresql env
      ansible.builtin.copy:
        src: ../deploy/postgresql/.env
        dest: "{{ app_dir }}/postgresql/.env"
        mode: "0600"
      register: env_file

    - name: Copy init schema
      ansible.builtin.copy:
        src: ../deploy/postgresql/init-schema.sql
        dest: "{{ app_dir }}/postgresql/init-schema.sql"
        mode: "0644"
      register: schema_file

    - name: Copy pg_hba.conf
      ansible.builtin.copy:
        src: ../deploy/postgresql/pg_hba.conf
        dest: "{{ app_dir }}/postgresql/pg_hba.conf"
        mode: "0644"
      register: pg_hba_file

    - name: Start containers
      ansible.builtin.shell:
        cmd: docker compose up -d
        chdir: "{{ app_dir }}"
      when: compose_file.changed or env_file.changed or schema_file.changed or pg_hba_file.changed
